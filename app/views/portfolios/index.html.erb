<h2>Portfolio <%= @projectName %></h2>
<% content_for :header_tags do %>
	
	<%= javascript_include_tag 'moment-with-locales', :plugin => 'portfolio_timeline' %>
	<script src="/plugin_assets/portfolio_timeline/vis/dist/vis.js"></script>
	<link href="/plugin_assets/portfolio_timeline/vis/dist/vis.css" rel="stylesheet" type="text/css" />
	<%= stylesheet_link_tag 'plugin_style', :plugin => 'portfolio_timeline' %>
	<%= javascript_include_tag 'plugin', :plugin => 'portfolio_timeline' %>
	
<% end %>
<div id="optMenu">
  <div class="optMenuItem" id="checkboxSection">
    <h4>Mostrar: </h3>
    <input type="checkbox" onclick="updateHitos()" id="hitosCheckbox">Hitos
	<input type="checkbox" onclick="updateProgressBar()" id="progressBarCheckbox">Indicador de progreso
  </div>
  <div class="optMenuItem" id="filterSection">
	<select>
	  <option selected disabled hidden style='display: none' value=''> -- Seleccione estado -- </option>
	  <% @statuses.each do |status| %>
	    <option value=<%= status.id %>><%= status.name %></option>
	  <% end %>
	</select>
	<button>Aplicar filtro</button>
	<button>Limpiar filtro</button>
  </div>
</div>

<div id="visualization"></div>
<script type="text/javascript">

  var container = document.getElementById('visualization');
  var groups = new vis.DataSet();

  var items = new vis.DataSet();
    <% @issues.each do |issue| %>
	<% @start = issue.custom_field_value(@startDateID) %>
	<% @end = issue.custom_field_value(@dueDateID) %>
	var button = '<button class="styledButton" onclick="moveWindow(<%= @start.split(/(\d{4})\-(\d{1,2})\-(\d{1,2})/) %>)"><img class=iconButton src="/plugin_assets/portfolio_timeline/images/beginnginIcon.svg"></img></button>';
	  groups.add({id: <%= issue.id %>,
		          content: '<div class="paddedTd"><%= issue.subject %></div><div class="paddedTd max50">'+button+'</div>',
				  subgroupOrder: function (a,b) {return a.subgroupOrder - b.subgroupOrder;},
				  subgroupStack: {'<%= issue.id %>-line': true, '<%= issue.id %>-hitos': true},
				  extraColumns: ['<%= issue.status %>','XX.XX Nombre del sistema/subsistema']
					});
	  var issueData = {
	  group: '<%= issue.id %>',
	  subgroup:'<%= issue.id %>-line',
	  subgroupOrder:1,
	  title:'Fecha inicio planificada: <%= @start %><br>Fecha fin planificada: <%= @end %>',
	  visibleFrameTemplate: '<div class="progress-wrapper"><div class="progress" style="width:<%= issue.done_ratio %>%"></div><label class="progress-label"><%= issue.done_ratio %>%<label></div>',
  	  start: '<%= @start %>',
  	  end: '<%= @end %>'};
	  items.add(issueData);
	  <% @hitos = issue.custom_field_value(@hitosFieldID).split(/(\[\d{4}-\d{1,2}-\d{1,2}\|.*\])/) %>
	  <% @hitos.each do |hito| %>
	    <% if !hito.blank? %>
	      <% hitoSplitted= hito.split(/\[(\d{4})\-(\d{1,2})\-(\d{1,2})\|(.*)\]/) %>
		  var hitoData = {start: '<%= hitoSplitted[1] %>-<%= hitoSplitted[2] %>-<%= hitoSplitted[3] %>',
			              content: '<%= hitoSplitted[4] %>',
			              group: '<%= issue.id %>',
			              subgroup: '<%= issue.id %>-hitos',
			              subgroupOrder:2,
						  title: 'Fecha: <%= hitoSplitted[1] %>-<%= hitoSplitted[2] %>-<%= hitoSplitted[3] %>',
			              type: 'point'};
		  items.add(hitoData);
	    <% end %>
	  <% end %>
  	<% end %>

    var options = {
	  locale:'es',
	  orientation: 'top',
	  groupOrder: 'id',
	  visibleFrameTemplate: function(item) {
        if (item.visibleFrameTemplate) {
          return item.visibleFrameTemplate;
        }
      },
	  groupTemplate: 	function(item) {
			var tableContent = '<div class="pseudoTable">\
									<div class="paddedTd">'+item.extraColumns[1]+'</div>\
									<div class="paddedTd max50">'+item.id+'\
									</div>'+item.content+'\
									<div class="paddedTd">'+item.extraColumns[0]+'</div>\
								</div>';
			return tableContent;
		}
	};

    var timeline = new vis.Timeline(container, items, options);
    timeline.setGroups(groups);
	var width = document.getElementsByClassName('vis-labelset')[0].offsetWidth;
	var layer = '<div id="pseudoTableHeaders">\
					<div class="pseudoTable">\
						<div class="paddedTd">Sistema</div>\
						<div class="paddedTd max50">ID</div>\
						<div class="paddedTd">Nombre</div>\
						<div class="paddedTd max50">Ir a inicio</div>\
						<div class="paddedTd">Estado</div>\
					</div>';
	$('.vis-timeline').first().prepend(layer);
	$('#pseudoTableHeaders').width(width);
  </script>
</html>